@model FeedbackViewModel
<script src="https://www.google.com/recaptcha/api.js?render=6LfY39gpAAAAABRCvKeAVSuJsqsO_9ScTnPbuHMn"></script>


<div class="modal fade" id="commentModal" tabindex="-1" aria-labelledby="commentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="commentModalLabel">@(!Model.IsSubmitted ? "Leave a Feedback" : "Thank You!")</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="feedbackModalBody">
                @if (!Model.IsSubmitted)
                {
                    <form id="feedbackForm">
                        <div class="form-outline mb-3">
                            <input type="email" class="form-control" id="customerEmail" name="CustomerEmail" placeholder="Please enter your name" required />
                        </div>
                        <div class="form-outline mb-3">
                            <textarea class="form-control" id="commentText" name="CommentText" rows="4" placeholder="Tell us what you are concerning" required></textarea>
                        </div>
                        <!-- Stars organized horizontally with click event listeners -->
                        <div class="form-outline mb-3">
                            <p>Rating: 
                                <span>
                                    <ul class="list-inline mb-3" id="starRating">
                                        <li class="list-inline-item"><i class="far fa-star fa-lg text-warning" data-rating="1"></i></li>
                                        <li class="list-inline-item"><i class="far fa-star fa-lg text-warning" data-rating="2"></i></li>
                                        <li class="list-inline-item"><i class="far fa-star fa-lg text-warning" data-rating="3"></i></li>
                                        <li class="list-inline-item"><i class="far fa-star fa-lg text-warning" data-rating="4"></i></li>
                                        <li class="list-inline-item"><i class="far fa-star fa-lg text-warning" data-rating="5"></i></li>
                                    </ul>
                                </span> 
                            </p>
                        </div>
                        <hr/>
                        <input type="hidden" name="Rating" id="ratingValue" />
                        <input type="hidden" name="FeedbackObject" id="feedbackObject" />
                        <input type="hidden" name="ObjectId" id="objectId" />
                        <input type="hidden" name="Status" id="status" />
                        <input type="hidden" name="IsRead" id="isRead" />
                        <!-- Add reCAPTCHA -->
                        <div class="form-outline mb-3">
                        <div class="g-recaptcha" data-sitekey="66LfY39gpAAAAABRCvKeAVSuJsqsO_9ScTnPbuHMn" style="margin: auto;"></div>
                        </div>
                        <div class="d-flex justify-content-between mt-3">
                            <button type="button" class="btn btn-primary" id="submitFeedback">Send feedback</button>
                        </div>
                    </form>
                }
                else
                {
                    <div class="alert alert-success">
                        <h5>Thank You for Your Feedback with KARNEL!</h5>
                        <p>We appreciate your kindness and will use it to improve our services.</p>
                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Return to KARNEL</button>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        var starRating = document.getElementById('starRating');
        if (starRating) {
            starRating.addEventListener('click', function (event) {
                if (event.target.dataset.rating) {
                    // Get the rating value from the clicked star
                    var rating = event.target.dataset.rating;
                    // Set the rating value to the hidden input field
                    document.getElementById('ratingValue').value = rating;

                    // Update the appearance of the stars based on the rating
                    var stars = document.querySelectorAll('#starRating i');
                    stars.forEach(star => {
                        star.classList.remove('fas', 'fa-star', 'text-warning'); // Remove solid star and color
                        star.classList.add('far'); // Switch to outline star

                        // Highlight solid stars up to the selected rating
                        if (star.dataset.rating <= rating) {
                            star.classList.add('fas', 'fa-star', 'text-warning');
                            star.classList.remove('far');
                        }
                    });
                }
            });
        }

        @* var commentModal = document.getElementById('commentModal');
        if (commentModal) {
            commentModal.addEventListener('shown.bs.modal', function () {
                document.getElementById('feedbackObject').value = 'Company';
                document.getElementById('objectId').value = 1234;
                document.getElementById('status').value = 'InActive';
                document.getElementById('isRead').value = 0;
                document.getElementById('ratingValue').value = document.getElementById('ratingValue').value || '5';
            });
        } *@

            var commentModal = document.getElementById('commentModal');
        if (commentModal) {
            commentModal.addEventListener('shown.bs.modal', function (event) {
                var triggerElement = event.relatedTarget; // Element that triggered the modal

                // Extract values from data attributes
                var feedbackObject = triggerElement.getAttribute('data-feedback-object');
                var objectId = triggerElement.getAttribute('data-object-id');

                // Set the values in the modal
                document.getElementById('feedbackObject').value = feedbackObject;
                document.getElementById('objectId').value = objectId;
                document.getElementById('status').value = 'InActive';
                document.getElementById('isRead').value = 0;
                document.getElementById('ratingValue').value = document.getElementById('ratingValue').value || '5';
            });
        }


        var submitButton = document.getElementById('submitFeedback');
        if (submitButton) {
            submitButton.addEventListener('click', function (event) {
                event.preventDefault();  // Prevent the default form submission

                grecaptcha.ready(function () {
                    grecaptcha.execute('6LfY39gpAAAAABRCvKeAVSuJsqsO_9ScTnPbuHMn', { action: 'submit' }).then(function (token) {
                        // Append the reCAPTCHA response token to your form data
                        var formData = new FormData(document.getElementById('feedbackForm'));
                        formData.append('recaptchaResponse', token);  // Ensure your server-side is ready to handle this param

                        // Make an AJAX POST request to submit the feedback
                        fetch('/Home/SubmitFeedback', {
                            method: 'POST',
                            body: formData
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    // Replace modal content with the "Thank You" message
                                    document.getElementById('feedbackModalBody').innerHTML = `
                                    <div class="alert alert-success">
                                        <h5>Thank You for Your Feedback!</h5>
                                        <p>We appreciate your input and will use it to improve our services.</p>
                                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
                                    </div>
                                    `;
                                } else {
                                    // Handle the case where reCAPTCHA or other server-side validation fails
                                    alert('Feedback submission failed. ' + (data.message || 'Please try again.'));
                                }
                            })
                            .catch(error => {
                                console.error('Error submitting feedback:', error);
                            });
                    });
                });
            });
        }
    });
</script>


